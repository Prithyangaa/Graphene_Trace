@{
    ViewData["Title"] = "Past Heat Map Viewer";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

<div class="gt-page">
    <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <nav class="small text-muted mb-1">
                    Dashboard / <span class="text-body">Past Heat Map Viewer</span>
                </nav>
                <h4 class="mb-0">Past Heat Map Viewer</h4>
            </div>
            <a href="@Url.Action("Dashboard", "Patient")" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>

        <div class="gt-card mb-3" style="cursor:default;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="small">
                    <strong>Time Range Selection</strong><br />
                    <span class="text-muted">Viewing: <span id="viewingLabel">0 min ago</span></span>
                </div>
                <div>
                    <select class="form-select form-select-sm">
                        <option>Last 24 hours</option>
                    </select>
                </div>
            </div>
            <input id="frameSlider" type="range" class="form-range" min="0" max="0" value="0" />
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="gt-card" style="cursor:default;">
                    <div class="gt-card-header">
                        <span>Historical Pressure Data</span>
                    </div>
                    <div class="gt-heatmap-preview" style="height:320px;">
                        <canvas id="pastHeatmapCanvas" width="320" height="320"
                            style="border-radius:16px; max-width:100%;"></canvas>
                        <small class="mt-2 text-muted">
                            Heat map at <span id="snapshotLabel">0 min ago</span>
                        </small>
                    </div>

                    <div class="mt-2 small text-muted">
                        Pressure Scale:
                        <span class="ms-2">Low</span>
                        <span class="ms-2">Medium</span>
                        <span class="ms-2">High</span>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="gt-card mb-3" style="cursor:default;">
                    <div class="gt-card-header">
                        <span>Recent Snapshots</span>
                    </div>
                    <div id="snapshotList" class="small"></div>
                </div>

                <div class="gt-card" style="cursor:default;">
                    <div class="gt-card-header">
                        <span>Pressure Over Time</span>
                    </div>
                    <div class="text-muted small">
                        (Placeholder) Line chart showing peak pressure vs time can go here.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const csvUrl = '@ViewBag.CsvUrl';
        const slider = document.getElementById('frameSlider');
        const canvas = document.getElementById('pastHeatmapCanvas');
        const ctx = canvas.getContext('2d');
        const viewingLabel = document.getElementById('viewingLabel');
        const snapshotLabel = document.getElementById('snapshotLabel');
        const snapshotList = document.getElementById('snapshotList');

        const size = 32;
        let frames = [];

        function drawFrame(index) {
            if (!frames.length) return;
            index = Math.max(0, Math.min(index, frames.length - 1));
            const frame = frames[index];
            const w = canvas.width / size;
            const h = canvas.height / size;
            let max = 0;
            frame.forEach(row => row.forEach(v => { if (v > max) max = v; }));

            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const v = frame[y][x] / (max || 1);
                    const r = Math.floor(255 * v);
                    const g = Math.floor(255 * (1 - v));
                    ctx.fillStyle = `rgb(${r},${g},180)`;
                    ctx.fillRect(x * w, y * h, w, h);
                }
            }

            const minsAgo = (frames.length - 1 - index) * 5; // assume 5 min interval
            viewingLabel.textContent = minsAgo + " min ago";
            snapshotLabel.textContent = viewingLabel.textContent;
        }

        if (csvUrl) {
            fetch(csvUrl)
                .then(r => r.text())
                .then(text => {
                    const lines = text.trim().split(/\r?\n/);
                    for (let i = 0; i + size <= lines.length; i += size) {
                        const frame = [];
                        for (let r = 0; r < size; r++) {
                            const rowVals = lines[i + r].split(',').map(Number);
                            frame.push(rowVals.slice(0, size));
                        }
                        frames.push(frame);
                    }

                    if (!frames.length) return;

                    slider.max = frames.length - 1;
                    slider.value = frames.length - 1;

                    // simple snapshot list (last 6)
                    const count = Math.min(6, frames.length);
                    for (let i = 0; i < count; i++) {
                        const index = frames.length - 1 - i;
                        const minsAgo = i * 5;
                        const div = document.createElement('div');
                        div.className = "mb-2 p-2 rounded-3";
                        div.style.background = "#f8fafc";
                        div.innerHTML = `<div>${minsAgo} min ago</div>
                            <div class="text-muted">Snapshot #${index}</div>`;
                        snapshotList.appendChild(div);
                    }

                    drawFrame(slider.value);
                });

            slider.addEventListener('input', () => drawFrame(slider.value));
        }
    </script>
}